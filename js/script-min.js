const SUPABASE_URL="https://exbgkztaevbqsofyecpu.supabase.co".trim(),SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4YmdrenRhZXZicXNvZnllY3B1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzEyNzAsImV4cCI6MjA4NjcwNzI3MH0.7A71chquy6YF1dqyHKGVHUiSZHPHP6YHZlvXupWM8hc",_supabase=supabase.createClient(SUPABASE_URL,SUPABASE_KEY),ui={userPanels:()=>document.querySelectorAll(".user-status-card"),modal:()=>document.querySelector("#upload-modal"),btnOpenUpload:()=>document.querySelector("#btn-open-upload"),btnCloseModal:()=>document.querySelector(".btn-close-modal"),fileInput:()=>document.querySelector(".input-file-video"),ytTitle:()=>document.querySelector(".input-yt-title"),ytCategory:()=>document.querySelector(".select-yt-category"),submitBtn:()=>document.querySelector(".btn-submit-meme"),grid:()=>document.querySelector("#meme-container"),filterBtns:()=>document.querySelectorAll(".filter-btn"),searchInput:()=>document.querySelector(".main-search-input"),fileLabel:()=>document.querySelector(".file-input-wrapper span"),mobileNavItems:()=>document.querySelectorAll(".mobile-nav .nav-item")},BureauNotification={show:e=>{const t=document.getElementById("system-notifier"),i=document.getElementById("notifier-content");t&&i&&(i.innerText=e,t.classList.remove("is-hidden"),setTimeout((()=>BureauNotification.close()),4e3))},close:()=>{document.getElementById("system-notifier")?.classList.add("is-hidden")}};async function initAuth(){_supabase.auth.onAuthStateChange(((e,t)=>updateUIBasedOnSession(t)));const{data:{session:e}}=await _supabase.auth.getSession();updateUIBasedOnSession(e)}function updateUIBasedOnSession(e){const t=ui.userPanels();0!==t.length&&t.forEach((t=>{if(e){const i=e.user.user_metadata;t.innerHTML=`\n                <div class="user-info-detail">\n                    <div style="display:flex; align-items:center; gap:10px;">\n                        <img src="${i.avatar_url||""}" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--accent);">\n                        <div>\n                            <div style="font-size:0.85rem; font-weight:700;">${i.full_name||"æ§åˆ¶å“¡"}</div>\n                            <div style="font-size:0.65rem; color:var(--accent);">å·²æ¥å…¥æ§åˆ¶ç³»çµ±</div>\n                        </div>\n                    </div>\n                    <button onclick="handleLogout()" class="logout-btn">ç™»å‡º</button>\n                </div>\n            `}else t.innerHTML='\n                <div class="user-info-detail">\n                    <button onclick="handleLogin()" class="btn-primary" style="margin:0; width:100%; padding:10px 20px; font-size:0.85rem;">\n                        <i class="ri-google-fill"></i> ç™»å…¥ç³»çµ±\n                    </button>\n                </div>\n            '}))}async function handleLogin(){await _supabase.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+window.location.pathname}})}async function handleLogout(){await _supabase.auth.signOut(),location.reload()}async function handleUpload(){const{data:{session:e}}=await _supabase.auth.getSession();if(!e)return BureauNotification.show("æ¬Šé™éŒ¯èª¤ï¼šè«‹å…ˆç™»å…¥æ§åˆ¶å±€ã€‚");const t=ui.fileInput()?.files[0],i=ui.ytTitle()?.value,n=ui.ytCategory()?.value;if(!t||!i||!n)return BureauNotification.show("è³‡è¨Šä¸å…¨ï¼Œç„¡æ³•å•Ÿå‹•å‚³è¼¸ã€‚");ui.submitBtn().disabled=!0,ui.submitBtn().innerHTML='<i class="ri-loader-4-line ri-spin"></i> ç‡’éŒ„ä¸­...';try{const a=t.name.split(".").pop().toLowerCase(),s=`${Date.now()}_${Math.random().toString(36).substring(7)}.${a}`,{data:o,error:l}=await _supabase.storage.from("memes").upload(s,t);if(l)throw l;const{data:{publicUrl:u}}=_supabase.storage.from("memes").getPublicUrl(s),{error:r}=await _supabase.functions.invoke("watermark",{body:{action:"verify-upload",videoUrl:u,title:i,category:n,userId:e.user.id}});if(r)throw r;BureauNotification.show("âœ… æŠ•ç¨¿å·²é€é”ï¼è«‹ç­‰å¾…æ§åˆ¶å±€å¯©æ ¸ç‡’éŒ„ã€‚"),setTimeout((()=>{ui.modal().style.display="none",ui.ytTitle().value="",ui.fileInput().value="",ui.submitBtn().disabled=!1,ui.submitBtn().innerText="æäº¤æŠ•ç¨¿"}),1500)}catch(e){BureauNotification.show(`å‚³è¼¸ä¸­æ–·: ${e.message}`),ui.submitBtn().disabled=!1,ui.submitBtn().innerText="é‡æ–°æŠ•ç¨¿"}}async function fetchMemes(e="all",t=""){let i=_supabase.from("memes").select("*").eq("status","approved");"all"!==e&&(i=i.eq("category",e)),t&&(i=i.ilike("title",`%${t}%`));const{data:n,error:a}=await i.order("created_at",{ascending:!1});if(a)return console.error(a);const s=ui.grid();s&&(n&&0!==n.length?s.innerHTML=n.map((e=>`\n            <div class="meme-card" onclick="location.href='view.html?id=${e.id}'">\n                <video src="${e.video_url}" muted loop playsinline onmouseenter="this.play()" onmouseleave="this.pause();this.currentTime=0;"></video>\n                <div class="card-info">\n                    <h3>${e.title}</h3>\n                    <span class="badge">${e.category}</span>\n                </div>\n            </div>\n        `)).join(""):s.innerHTML='<div class="empty-state">å°šç„¡æ ¸å‡†å…§å®¹</div>')}function listenToChanges(){_supabase.channel("realtime-memes").on("postgres_changes",{event:"*",schema:"public",table:"memes"},(()=>fetchMemes())).subscribe()}function switchTab(e){ui.mobileNavItems().forEach((t=>{t.classList.remove("active"),t.outerHTML.includes(e)&&t.classList.add("active")})),"upload"===e?ui.modal().style.display="flex":"home"===e&&(ui.modal().style.display="none",window.scrollTo({top:0,behavior:"smooth"})),console.log(`ğŸ“¡ ç³»çµ±å°èˆªè‡³: ${e}`)}window.closeNotifier=BureauNotification.close,window.switchTab=switchTab,window.handleLogin=handleLogin,window.handleLogout=handleLogout,document.addEventListener("DOMContentLoaded",(()=>{initAuth(),fetchMemes(),listenToChanges(),ui.btnOpenUpload()?.addEventListener("click",(()=>ui.modal().style.display="flex")),ui.btnCloseModal()?.addEventListener("click",(()=>ui.modal().style.display="none")),ui.submitBtn()?.addEventListener("click",handleUpload),ui.searchInput()?.addEventListener("input",(e=>fetchMemes("all",e.target.value))),ui.filterBtns().forEach((e=>{e.addEventListener("click",(()=>{ui.filterBtns().forEach((e=>e.classList.remove("active"))),e.classList.add("active"),fetchMemes(e.dataset.cat)}))})),ui.fileInput()?.addEventListener("change",(e=>{ui.fileLabel()&&e.target.files[0]&&(ui.fileLabel().innerHTML=`å·²é–å®šï¼š<b style="color:#00ffcc;">${e.target.files[0].name}</b>`)}));const e=document.querySelector(".file-input-wrapper"),t=ui.fileInput();e&&t&&e.addEventListener("click",(()=>{t.click()})),t?.addEventListener("change",(e=>{ui.fileLabel()&&e.target.files[0]&&(ui.fileLabel().innerHTML=`å·²é–å®šï¼š<b style="color:#00ffcc;">${e.target.files[0].name}</b>`)}))}));