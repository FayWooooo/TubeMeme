const SUPABASE_URL="https://exbgkztaevbqsofyecpu.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4YmdrenRhZXZicXNvZnllY3B1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzEyNzAsImV4cCI6MjA4NjcwNzI3MH0.7A71chquy6YF1dqyHKGVHUiSZHPHP6YHZlvXupWM8hc",_supabase=supabase.createClient(SUPABASE_URL,SUPABASE_KEY),DetailControl={params:new URLSearchParams(window.location.search),memeId:null,memeData:null,async init(){this.memeId=this.params.get("id"),this.memeId?(await this.loadContent(),await this.setupInteraction()):console.error("缺少 ID 參數")},async loadContent(){const{data:e,error:t}=await _supabase.from("memes").select("*").eq("id",this.memeId).single();if(t||!e)return alert("檔案不存在或已被移除"),void(window.location.href="index.html");this.memeData=e;const i=e.video_url||e.yt_video_id,n=document.querySelector(".media-target"),o=i.toLowerCase().endsWith(".gif");if(n)if(n.innerHTML="",o)n.innerHTML=`<img src="${i}" class="media-content">`;else{const e=document.createElement("video");e.src=i,e.className="media-content",e.autoplay=!0,e.loop=!0,e.muted=!0,e.playsInline=!0,e.setAttribute("webkit-playsinline","true"),n.appendChild(e),this.setupVideoUI(e)}document.querySelector(".meme-title").innerText=e.title||"無標題",document.querySelector(".meme-category").innerText=e.category||"一般"},setupVideoUI(e){const t=document.querySelector(".video-ui-overlay"),i=document.querySelector(".btn-play-toggle"),n=document.querySelector(".btn-mute-toggle"),o=document.querySelector(".progress-current"),a=document.querySelector(".time-display"),r=document.querySelector(".progress-wrap");if(!t||!i||!n)return;t.classList.remove("is-hidden"),n.innerHTML='<i class="ri-volume-mute-line"></i>',i.innerHTML='<i class="ri-pause-fill"></i>';const s=()=>{e.paused?(e.play(),i.innerHTML='<i class="ri-pause-fill"></i>'):(e.pause(),i.innerHTML='<i class="ri-play-fill"></i>')};i.onclick=e=>{e.stopPropagation(),s()},e.onclick=s,n.onclick=t=>{t.stopPropagation(),e.muted=!e.muted,n.innerHTML=e.muted?'<i class="ri-volume-mute-line"></i>':'<i class="ri-volume-up-line"></i>'},e.ontimeupdate=()=>{if(e.duration){const t=e.currentTime/e.duration*100;o&&(o.style.width=`${t}%`);const i=e=>isNaN(e)?"00:00":`${Math.floor(e/60).toString().padStart(2,"0")}:${Math.floor(e%60).toString().padStart(2,"0")}`;a&&(a.innerText=`${i(e.currentTime)} / ${i(e.duration)}`)}},r&&(r.onclick=t=>{t.stopPropagation();const i=r.getBoundingClientRect(),n=(t.clientX-i.left)/i.width;e.currentTime=n*e.duration})},async setupInteraction(){const{data:{session:e}}=await _supabase.auth.getSession();e&&document.querySelector(".comment-input-group")?.classList.remove("is-hidden"),document.querySelector(".btn-download")?.addEventListener("click",(e=>this.handleDownload(e.currentTarget))),document.querySelector(".btn-like")?.addEventListener("click",(t=>this.handleLike(t.currentTarget,e))),document.querySelector(".btn-back")?.addEventListener("click",(()=>{window.history.length>1?history.back():window.location.href="index.html"}))},async handleDownload(e){if(!this.memeData)return;const t=e.innerHTML,i=this.memeData.video_url||this.memeData.yt_video_id;try{e.classList.add("is-loading"),e.innerHTML='<i class="ri-loader-4-line ri-spin"></i> 下載中...';const t=await fetch(i),n=await t.blob(),o=window.URL.createObjectURL(n),a=i.split(".").pop().split("?")[0]||"mp4",r=document.createElement("a");r.href=o,r.download=`${this.memeData.title||"meme"}.${a}`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(o)}catch(e){console.error("Download Error:",e),alert("因瀏覽器安全限制，下載失敗。請長按影片選擇另存新檔。")}finally{e.classList.remove("is-loading"),e.innerHTML=t}},async handleLike(e,t){if(!t)return alert("請先登入才能按讚");e.classList.toggle("is-active");const i=e.querySelector(".like-count");if(i){const t=parseInt(i.innerText)||0;i.innerText=e.classList.contains("is-active")?t+1:Math.max(0,t-1)}}};document.addEventListener("DOMContentLoaded",(()=>DetailControl.init()));